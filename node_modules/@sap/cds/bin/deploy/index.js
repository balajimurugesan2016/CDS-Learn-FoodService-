module.exports = Object.assign(deploy, {
  options: ['--to', '--tunnel-address'], flags: ['--no-save', '--auto-undeploy'],
  shortcuts: ['-2'],
  help: `
# SYNOPSIS

    *cds deploy* [ <model> ] [ <options> ]

    Deploys the given model to a database. If no model is given it looks up
    according configuration from _package.json_ or _.cdsrc.json_ in key
    _cds.requires.db_.  Same for the database.

    Supported databases: sqlite, hana


# OPTIONS
    *-2* | *--to* <database> [ : <database specific parameter> ],
      where <database> is 'sqlite' or 'hana', <database specific parameter>
      can be a path to the database file (sqlite) or the service name (hana).

    *--no-save*
      Do not modify the package.json file.

    *--auto-undeploy* (beta feature)
      Tell HDI deployer to automatically undeploy deleted resources

    *--tunnel-address* (beta feature)
      Deploy through the given address (host:port) rather than the original
      database address.  The tunnel must have been opened before, e.g. using 'cf ssh'.

# EXAMPLES
    cds deploy --to sqlite:db
    cds deploy --to hana:myService --auto-undeploy

`})

const cds = require('../../lib/cds')

async function deploy ([_model], options) { // NOSONAR

  const { 'to':url, 'no-save':no_save = cds.env.deploy.no_save } = options
  if (!url && !cds.env.requires.db)  throw new Error(`

  There's no database configured in 'cds.require.db'.
  Please do so or specify one, e.g.:

      cds deploy --to sqlite:db/my.db
  `)

  const [,_kind,_db] = /(\w+)?(?::(.*))?/.exec(url||'')
  const conf = cds.env.requires.db || {}
  const kind = _kind || conf.kind
  const model = _model || conf.model || ['db','srv']

  try {
    const deploy = require ('./to-'+kind)
    await deploy (_model, kind, _db, options)
    if (kind === 'hana')  return // REVISIT: the hana deployer is a bit special
    if (url && !no_save)  await updata_package_json (_kind, model, _db)
  } catch (e) {
    if (e.code === 'MODULE_NOT_FOUND') {
      throw new Error(`Didn't find a deployer for '${kind}'`)
    }
    if (e.code === 'MODEL_NOT_FOUND' && !model) {
      throw new Error('Please specify a data model or configure one in package.json#cds.requires.db.model')
    } else throw e
  }
}


function updata_package_json (kind,model,database) { try {
  const package_json = require('path') .resolve ('package.json')
  const conf = require (package_json)
  const requires = ['cds','requires'] .reduce ((p,n)=>p[n] || (p[n]={}), conf)
  cds.env.requires.db = requires.db = { kind, model }
  if (database)  requires.db.credentials = {database}
  const write = require('util').promisify (require('fs').writeFile)
  return write (package_json, JSON.stringify(conf,null,'  ')).then (()=>
    console.log (' > updated package.json')
  )
} catch(e){/* ignore */}}

/* eslint no-console: off */
