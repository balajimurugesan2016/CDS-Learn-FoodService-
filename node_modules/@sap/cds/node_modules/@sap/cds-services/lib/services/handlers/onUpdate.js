const {
  messages: { DB_CONNECTION_MISSING }
} = require('../utils/constants')
const getColumns = require('../utils/columns')
const { fillDataDeep } = require('../../util/dataProcessUtils')
const { getSelectCQN, checkNotNull, filterReadOnly } = require('../utils/handlerUtils')
const { resolveCqnIfView, getTargetData } = require('../utils/defaultHandlers')

const _getInsertCQN = context => {
  const { target, data } = getTargetData(context.target, Object.assign({}, context.data))

  return context.statements.INSERT.into(target).entries([data])
}

const _insertMissingUpsert = async context => {
  if (checkNotNull(context)) {
    return
  }
  filterReadOnly(context)

  fillDataDeep(context.data, context.target, 'POST', context.user)

  await context.run(_getInsertCQN(context))

  return context.data
}

const _insertMissingUpdate = context => {
  fillDataDeep(context.data, context.target, context._.isPatch ? 'PATCH' : 'PUT', context.user)
}

const _containsChanges = context => {
  return Object.keys(context.data).length > 1
}

/**
 * Generic Handler for UPDATE requests.
 * In case of success it returns the updated entry.
 * If the entry to be updated does not exist, a new entry is created.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onUpdate
 */
const onUpdate = () => async context => {
  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return context.data
  }

  const checkExistCQN = getSelectCQN(context, getColumns(context.target, true))
  const result = checkExistCQN ? await context.run(checkExistCQN) : []

  // No key information given, or entry is not available -> create a new one
  if (result.length === 0) {
    return _insertMissingUpsert(context)
  }

  _insertMissingUpdate(context)

  // Store for auditing
  context._oldData = result[0]
  filterReadOnly(context)
  // reject with error if query update fails (not authenticated)
  if (_containsChanges(context) && (await context.run(resolveCqnIfView(context))) === 0) {
    context.reject(403)
    return
  }

  return Object.assign({}, result[0], context.data)
}

module.exports = onUpdate
